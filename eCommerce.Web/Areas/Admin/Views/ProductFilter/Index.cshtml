
@{
    ViewData["Title"] = "BỘ LỌC SẢN PHẨM";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <div class="button-list">
                        <button onclick="loadAllCategories()" type="button" class="btn btn-primary"><i class="mdi mdi-refresh font-16 mr-1"></i>Làm mới dữ liệu</button>
                    </div>
                </div>
                <h4 class="page-title">Tùy chỉnh bộ lọc sản phẩm</h4>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div>
                        <ul class="nav nav-tabs nav-bordered mb-3">
                            <li class="nav-item"><a href="#tab-template" data-toggle="tab" class="nav-link active"><span>Danh mục sản phẩm</span></a></li>
                        </ul>
                        <div class="tab-content ml-3">
                            <div class="tab-pane show active" id="tab-template">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal add value-->
<div id="modal-view-value" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="standard-modalLabel">Giá trị</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="form-group row mb-3">
                        <label class="col-3 col-form-label">Tên bộ lọc</label>
                        <div class="col-9">
                            <input type="text" class="form-control" autocomplete="off" value="Giá" readonly>
                        </div>
                    </div>
                    <div class="form-group row mb-3">
                        <label class="col-3 col-form-label">Giá trị lọc</label>
                        <div class="col-9">
                            <span class="badge badge-primary-lighten">450.000đ</span>
                            <span class="badge badge-primary-lighten">560.000đ</span>
                            <span class="badge badge-primary-lighten">1.500.000đ</span>
                            <span class="badge badge-primary-lighten">1.650.000đ</span>
                            <span class="badge badge-primary-lighten">2.250.000đ</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal"><i class="mdi mdi-close mr-1"></i>Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal edit filter -->
<div id="modal-edit-filter" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Cập nhật bộ lọc </h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="form-group row mb-3">
                        <label class="col-3 col-form-label">Thuộc tính</label>
                        <div class="col-9">
                            <input id="modal-edit-ipt-property-name" readonly class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Giá trị lọc</label>
                        <button type="button" name="btn-add-value" class="btn btn-primary  btn-sm m-1 float-right">Thêm giá trị</button>
                        <select id="modal-edit-sl-values" class="select2 form-control select2-multiple" data-toggle="select" multiple="multiple">
                        </select>

                    </div>
                </div>
            </div>
            <div class="modal-footer">

                <button id="btn-delete" type="button" class="btn btn-danger m-w-100 mr-auto ml-1"><i class="mdi mdi-trash-can mr-1"></i>Xoá</button>
                <button type="button" class="btn btn-light" data-dismiss="modal"><i class="mdi mdi-close mr-1"></i>Đóng</button>
                <button id="modal-edit-btn-save-filter" type="button" class="btn btn-primary"><i class="mdi mdi-check mr-1"></i>Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal add filter -->
<div id="modal-add-filter" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="standard-modalLabel">Thêm bộ lọc </h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="form-group row mb-3">
                        <label class="col-3 col-form-label">Thuộc tính <span class="text-danger">*</span></label>
                        <div class="col-9">
                            <select id="sl-property" class="form-control select2" data-toggle="select">
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Giá trị lọc <span class="text-danger">*</span></label>
                        <button type="button" onclick="AddValueProperty('#sl-filter-values');" class="btn btn-primary  btn-sm m-1 float-right">Thêm giá trị</button>
                        <select id="sl-filter-values" class="select2 form-control select2-multiple" data-toggle="select" multiple="multiple">
                        </select>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal"><i class="mdi mdi-close mr-1"></i>Đóng</button>
                <button id="btn-save-filter" type="button" class="btn btn-primary"><i class="mdi mdi-check mr-1"></i>Lưu bộ lọc</button>
            </div>
        </div>
    </div>
</div>

<!--  Modal thêm giá trị thuộc tính -->
<div class="modal fade" id="modal-add-value">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="height:400px;">
            <div class="modal-header">
                <h4 class="modal-title">Tạo thuộc tính</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="form-group mb-3">
                            <label for="ipt-value"><span class="text-danger"> &nbsp;* </span><span id="modal-label"></span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="ipt-value">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-add" type="button" class="btn btn-primary">Thêm mới</button>
                <button type="button" class="btn btn-light" data-dismiss="modal">Đóng</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
@section Scripts {
    <script>
        var CATEGORY_ID = 0;
        $(document).ready(function () {
            loadAllCategories();
        })
        function loadAllCategories() {
            ajaxGet('ProductCategory/GetFilter', null,
                function (rs) {
                    if (rs.IsSuccess) {
                        var data = rs.Result;
                        let html = data.map(n => (`
                                                    <div class="mt-2">
                                                        <a class="text-dark collapsed" data-toggle="collapse" href="#collapse-${n.Id}">
                                                        <p class="m-0 font-weight-bold"><i class="uil uil-angle-down font-18"></i>${n.CategoryName} <span class="text-muted">(${n.PropertyFilters.length} bộ lọc)</span></p>
                                                        </a>
                                                        <div class="collapse ml-4 mt-1" id="collapse-${n.Id}">
                                                            ${showProperty(n.PropertyFilters)}
                                                             <div onclick="openModalAddFilter(${n.Id})"><p class="cursor-pointer text-primary"><button type="button" class="btn btn-sm btn-primary"><i class="mdi mdi-plus mr-1"></i>Thêm bộ lọc</button></div>
                                                        </div>
                                                    </div>`));
                        $('#tab-template').html(html);

                    } else {
                        alertify.error(rs.Message);
                    }
                }
            );
            function showProperty(properties) {
                let html = "";
                properties.map(n => {
                    html += `<div onclick="showModalValueEdit(${n.Id})" class="justify-content-sm-between"><p class="cursor-pointer">${n.PropertyName} (${n.Values.filter(n => n.IsFilter).length} giá trị)</p></div>`;
                });
                return html;
            }
        }

        /*Lấy giá trị value khi đổi properties*/
        $('#sl-property').on('change', function () {
            let id = $('#sl-property').val();
            if (IsNullOrEmpty(id)) return;
            ajaxGet('Property/' + $('#sl-property').val(), null,
                function (rs) {
                    if (rs.IsSuccess) {
                        $('#sl-filter-values').html(rs.Result.Values.map(n => `<option value="${n.Id}">${n.Value}</option>`));
                    } else {
                        alertify.error(rs.Message);
                    }
                }
            );
        });

        /*Modal edit  property value*/
        function showModalValueEdit(propId) {
            ajaxGet('Property/' + propId, null, function (res) {
                var $slValuesEdit = $('#modal-edit-sl-values');
                if (res.IsSuccess) {
                    let data = res.Result;
                    $('#modal-edit-ipt-property-name').val(data.PropertyName);
                    let html = data.Values.map(n => (`<option value="${n.Id}">${n.Value}</option>`))
                    $slValuesEdit.html(html);
                    let values = data.Values.filter(n => n.IsFilter);
                    let valueIds = values.map(n => n.Id);
                    $slValuesEdit.val(valueIds);
                }
            })
            let $modalEdit = $('#modal-edit-filter');
            showModal('#modal-edit-filter', "#modal-edit-btn-save-filter", function () {
                let values = $('#modal-edit-sl-values').val();
                if (values.length == 0)
                    alertify.alert("Chọn ít nhất 1 giá trị lọc");
                else {
                    ajaxPut('property/setFilter/' + propId, {
                        Type: true,
                        ValueIds: values.map(n => parseInt(n))
                    }, function (res) {

                        if (res.IsSuccess) {
                            alertify.success("Cập nhật thành công");
                            loadAllCategories();
                            hideModal('#modal-edit-filter');
                        } else {
                            alertify.error(rs.Message);
                        }

                    });
                }
            });
            $modalEdit.find("#btn-delete").unbind().on('click', function () {
                alertify.confirm("Xác nhận xóa thuộc tính khỏi bộ lọc", function () {
                    ajaxPut('property/setFilter/' + propId, {
                        Type: false,
                        ValueIds: []
                    },
                        function (rs) {
                            if (rs.IsSuccess) {
                                alertify.success("Xóa thành công")
                                $("#ipt-add-name").val("");
                                loadAllCategories();
                                hideModal("#modal-edit-filter");
                            } else {
                                alertify.error(rs.Message);
                            }

                        }
                    );
                })
            })
            $modalEdit.find('button[name="btn-add-value"]').unbind().on('click', function () {
                AddValueProperty('#modal-edit-sl-values', propId);
            })
        }

        /*Modal add property's value*/
        function openModalAddFilter(categoryId) {
            CATEGORY_ID = categoryId;
            initSelect({
                Element: '#sl-property',
                Url: URL_BASE.Property + "/ByCategory/" + CATEGORY_ID,
                Value: "PropertyName",
                Id: "Id",
                Placeholder: "Nhập tên thuộc tính"
            }, false, () => { $('#sl-property').val('').trigger('change'); });
            showModal('#modal-add-filter', "#btn-save-filter", function () {
                try {
                    let PropertyId = $('#sl-property').val();
                    let valueIds = $('#sl-filter-values').val();

                    if (IsNullOrEmpty(PropertyId))
                        alertify.alert('Tên thuộc tính không được để trống');
                    else if (IsNullOrEmpty(valueIds) || valueIds.length == 0)
                        alertify.alert('Chưa chọn giá trị lọc');
                    else {
                        ajaxPut('property/setFilter/' + PropertyId, {
                            Type: true,
                            ValueIds: valueIds.map(n => parseInt(n))
                        },
                            function (rs) {
                                if (rs.IsSuccess) {
                                    alertify.success("Thêm thành công")
                                    $("#ipt-add-name").val("");
                                    loadAllCategories();
                                    hideModal("#modal-add-filter");
                                } else {
                                    alertify.error(rs.Message);
                                }
                            }
                        );

                    }

                } catch (e) {
                    alertify.error(e);
                }
            });


        }

        /*Show modal add property values
         element: select thêm option sau khi add value
         propId: trong modal add lay propId Trong select property
                trong modal edit lay propId truyen vao khi show modal
         */
        function AddValueProperty(element, propId) {
            let idString = $('#sl-property').val();
            if (IsNullOrEmpty(idString)) {
                alertify.alert('Chưa chọn thuộc tính');
                return;
            }
            let idProperty = IsNullOrEmpty(propId) ? parseInt(idString) : propId;
            $('#modal-label').text("Nhập giá trị thuộc tính");
            showModal('#modal-add-value', '#btn-add', function () {
                let value = $('#ipt-value').val();// input trong modal
                if (IsNullOrEmpty(value))
                    alertify.alert("Nhập giá trị thuộc tính");
                else {
                    ajaxPost('Value', {
                        PropertyId: idProperty,
                        Value: value
                    }, function (res) {

                        if (res.IsSuccess) {
                            $(element).prepend(`<option value="${res.Result.Id}">${res.Result.Value}</option>`)
                            hideModal('#modal-add-value');
                        }

                    });
                }
            })

        }

    </script>
}

